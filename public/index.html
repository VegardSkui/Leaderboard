<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <meta name="robots" content="noindex">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>üèì Revolve Ping-Pong</title>
    <link href="https://unpkg.com/tailwindcss@^1.0/dist/tailwind.min.css" rel="stylesheet">
</head>
<body>
    <div class="container mx-auto px-2">
        <h1 class="my-4 text-xl">üèì Revolve Ping-Pong<sup>BETA</sup></h1>

        <form id="add-game-form">
            <div class="items-end mb-3 sm:flex">
                <div class="mb-3 sm:mr-2 sm:mb-0 sm:flex-1">
                    <label class="block text-gray-700 text-sm fond-bold mb-1" for="winner">Winner</label>
                    <input class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline" type="text" id="winner" required />
                </div>
                <div class="mb-3 sm:mr-2 sm:mb-0 sm:flex-1">
                    <label class="block text-gray-700 text-sm fond-bold mb-1" for="looser">Looser</label>
                    <input class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline" type="text" id="looser" required />
                </div>
                <button class="bg-blue-500 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded" type="submit">Add Game</button>
            </div>
        </form>

        <table class="table-auto">
            <thead>
                <tr>
                    <th class="px-4 py-2">Rank</th>
                    <th class="px-4 py-2">Name</th>
                    <th class="px-4 py-2">Wins</th>
                    <th class="px-4 py-2">Losses</th>
                </tr>
            </thead>
            <tbody id="table-body"></tbody>
        </table>

        <div class="my-4">
            <span id="total">0</span> games have been played
        </div>
    </div>

    <!-- Add SDKs for Firebase -->
    <script src="/__/firebase/7.3.0/firebase-app.js"></script>
    <script src="/__/firebase/7.3.0/firebase-firestore.js"></script>

    <!-- Initialize Firebase -->
    <script src="/__/firebase/init.js"></script>

    <script>
const db = firebase.firestore();

// Connect to the emulator if on localhost
if (location.hostname === "localhost") {
    db.settings({
        host: "localhost:8080",
        ssl: false
    })
}

const defaultRank = 1000
const kFactor = 16

/**
 * Calculates the probability of a player winning against an opponent using
 * their current ranks
 * @param {number} playerRank - The current rank of the player
 * @param {number} opponentRank - The current rank of the opponent
 * @returns {number} The probability, a number in the range [0, 1]
 */
function winProbability(playerRank, opponentRank) {
    return 1.0 / (10.0 ** ((opponentRank - playerRank) / 400.0) + 1.0)
}

/**
 * Calculates the new ranks for the winner and looser of a game using their
 * current ranks
 * @param {number} currentWinnerRank - The current rank of the winner
 * @param {number} currentLooserRank - The current rank of the looser
 * @returns {Array} An array with the new rank of the winner on index 0 and the new rank of the looser on index 1
 */
function newRanks(currentWinnerRank, currentLooserRank) {
    let winnerRank = currentWinnerRank + kFactor * (1.0 - winProbability(currentWinnerRank, currentLooserRank))
    let looserRank = currentLooserRank + kFactor * (0.0 - winProbability(currentLooserRank, currentWinnerRank))
    return [winnerRank, looserRank]
}

/**
 * Adds a new game to the database with the specified winner and looser, will
 * also update the player records and the table
 * @param {string} Username of the winner
 * @param {string} Username of the looser
 */
function addGame(winner, looser) {
    const winnerDoc = db.collection("players").doc(winner)
    const looserDoc = db.collection("players").doc(looser)

    // Get the records for the winner and looser
    getWinner = winnerDoc.get()
    getLooser = looserDoc.get()

    // Store a record of the game itself
    db.collection("games").add({
        winner: winner,
        looser: looser,
        date: new Date()
    })

    Promise.all([getWinner, getLooser]).then(data => {
        // Get the existing data for the winner/looser, or use default data
        let winner = data[0].exists ? data[0].data() : { rank: defaultRank, wins: 0, losses: 0 }
        let looser = data[1].exists ? data[1].data() : { rank: defaultRank, wins: 0, losses: 0 }

        // Calculate the updated ranks for the players
        let ranks = newRanks(winner["rank"], looser["rank"])
        winner["rank"] = ranks[0]
        looser["rank"] = ranks[1]

        // Update wins and losses
        winner["wins"]++
        looser["losses"]++

        // Store the updated ranks
        updateWinner = winnerDoc.set(winner)
        updateLooser = looserDoc.set(looser)

        // Update the table when the results have been stored
        Promise.all([updateWinner, updateLooser]).then(updateTable)
    })
}

/**
 * Updates the table of players with the latest data from the database
 */
function updateTable() {
    db.collection("players").orderBy("rank", "desc").get().then(querySnapshot => {
        const table = document.getElementById("table-body")

        // Reset the table
        table.innerHTML = ""

        // Add a new table row for each player
        var total = 0
        var next_standing = 1
        querySnapshot.forEach(doc => {
            let row = document.createElement("tr")
            if (next_standing % 2 == 0) {
                row.classList.add("bg-gray-100")
            }

            let standing = document.createElement("td")
            standing.textContent = next_standing++
            standing.classList.add("border", "px-4", "py-2")

            let name = document.createElement("td")
            name.textContent = doc.id
            name.classList.add("border", "px-4", "py-2")
            name.title = doc.data().rank

            let wins = document.createElement("td")
            wins.textContent = doc.data().wins
            wins.classList.add("border", "px-4", "py-2")

            let losses = document.createElement("td")
            losses.textContent = doc.data().losses
            losses.classList.add("border", "px-4", "py-2")

            row.appendChild(standing)
            row.appendChild(name)
            row.appendChild(wins)
            row.appendChild(losses)
            table.appendChild(row)

            total += doc.data().wins
        })

        // Update the count of total games played
        document.getElementById("total").textContent = total
    })
}

document.getElementById("add-game-form").onsubmit = e => {
    // Don't reload the page
    e.preventDefault()

    const winnerInput = document.getElementById("winner")
    const looserInput = document.getElementById("looser")

    // Add the game
    addGame(winnerInput.value.trim(), looserInput.value.trim())

    // Clear the inputs
    winnerInput.value = ""
    looserInput.value = ""

    // Give focus to the winner field
    winnerInput.focus()
}

// Give winner field focus and do initial table update on load
document.getElementById("winner").focus()
updateTable()
    </script>
</body>
</html>
