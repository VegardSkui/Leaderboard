<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>üèì Revolve Ping-Pong</title>
    <link href="https://unpkg.com/tailwindcss@^1.0/dist/tailwind.min.css" rel="stylesheet">
</head>
<body>
    <div class="container mx-auto px-2">
        <h1 class="my-4 text-xl">üèì Revolve Ping-Pong<sup>BETA</sup></h1>

        <form id="add-game-form">
            <div class="items-end mb-3 sm:flex">
                <div class="mb-3 sm:mr-2 sm:mb-0 sm:flex-1">
                    <label class="block text-gray-700 text-sm fond-bold mb-1" for="winner">Winner</label>
                    <input class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline" type="text" id="winner" required />
                </div>
                <div class="mb-3 sm:mr-2 sm:mb-0 sm:flex-1">
                    <label class="block text-gray-700 text-sm fond-bold mb-1" for="looser">Looser</label>
                    <input class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline" type="text" id="looser" required />
                </div>
                <button class="bg-blue-500 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded" type="submit">Add Game</button>
            </div>
        </form>

        <table class="table-auto mb-4">
            <thead>
                <tr>
                    <th class="px-4 py-2">Rank</th>
                    <th class="px-4 py-2">Name</th>
                </tr>
            </thead>
            <tbody id="table-body"></tbody>
        </table>
    </div>

    <!-- Add SDKs for Firebase -->
    <script src="https://www.gstatic.com/firebasejs/7.3.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/7.3.0/firebase-firestore.js"></script>

    <script>
// Firebase configuration
var firebaseConfig = {
    apiKey: "AIzaSyBSWf6lJ3bBrUva3h9Vp4IYZevIqZ7iHAk",
    authDomain: "revolve-ping-pong.firebaseapp.com",
    databaseURL: "https://revolve-ping-pong.firebaseio.com",
    projectId: "revolve-ping-pong",
    storageBucket: "revolve-ping-pong.appspot.com",
    messagingSenderId: "522403411478",
    appId: "1:522403411478:web:c9a3f1de5bd527c5292737"
};

// Initialize Firebase
firebase.initializeApp(firebaseConfig);

const db = firebase.firestore();

const defaultRank = 1000
const kFactor = 16

/**
 * Calculates the probability of a player winning against an opponent using
 * their current ranks
 * @param {number} playerRank - The current rank of the player
 * @param {number} opponentRank - The current rank of the opponent
 * @returns {number} The probability, a number in the range [0, 1]
 */
function winProbability(playerRank, opponentRank) {
    return 1.0 / (10.0 ** ((opponentRank - playerRank) / 400.0) + 1.0)
}

/**
 * Calculates the new ranks for the winner and looser of a game using their
 * current ranks
 * @param {number} currentWinnerRank - The current rank of the winner
 * @param {number} currentLooserRank - The current rank of the looser
 * @returns {Array} An array with the new rank of the winner on index 0 and the new rank of the looser on index 1
 */
function newRanks(currentWinnerRank, currentLooserRank) {
    let winnerRank = currentWinnerRank + kFactor * (1.0 - winProbability(currentWinnerRank, currentLooserRank))
    let looserRank = currentLooserRank + kFactor * (0.0 - winProbability(currentLooserRank, currentWinnerRank))
    return [winnerRank, looserRank]
}

/**
 * Adds a new game to the database with the specified winner and looser, will
 * also update the player records and the table
 * @param {string} Username of the winner
 * @param {string} Username of the looser
 */
function addGame(winner, looser) {
    const winnerDoc = db.collection("players").doc(winner)
    const looserDoc = db.collection("players").doc(looser)

    // Get the records for the winner and looser
    getWinner = winnerDoc.get()
    getLooser = looserDoc.get()

    // Store a record of the game itself
    db.collection("games").add({
        winner: winner,
        looser: looser,
        date: new Date()
    })

    Promise.all([getWinner, getLooser]).then(data => {
        let winnerRank = data[0].exists ? data[0].data().rank : defaultRank
        let looserRank = data[1].exists ? data[1].data().rank : defaultRank

        // Calculate the updated ranks for the players
        let ranks = newRanks(winnerRank, looserRank)

        // Store the updated ranks
        updateWinner = winnerDoc.set({ rank: ranks[0] })
        updateLooser = looserDoc.set({ rank: ranks[1] })

        // Update the table when the results have been stored
        Promise.all([updateWinner, updateLooser]).then(updateTable)
    })
}

/**
 * Updates the table of players with the latest data from the database
 */
function updateTable() {
    db.collection("players").orderBy("rank", "desc").get().then(querySnapshot => {
        const table = document.getElementById("table-body")

        // Reset the table
        table.innerHTML = ""

        // Add a new table row for each player
        var next_standing = 1
        querySnapshot.forEach(doc => {
            let row = document.createElement("tr")
            if (next_standing % 2 == 0) {
                row.classList.add("bg-gray-100")
            }

            let standing = document.createElement("td")
            standing.textContent = next_standing++
            standing.classList.add("border", "px-4", "py-2")

            let name = document.createElement("td")
            name.textContent = doc.id
            name.classList.add("border", "px-4", "py-2")
            name.title = doc.data().rank

            row.appendChild(standing)
            row.appendChild(name)
            table.appendChild(row)
        })
    })
}

document.getElementById("add-game-form").onsubmit = e => {
    // Don't reload the page
    e.preventDefault()

    const winnerInput = document.getElementById("winner")
    const looserInput = document.getElementById("looser")

    // Add the game
    addGame(winnerInput.value.trim(), looserInput.value.trim())

    // Clear the inputs
    winnerInput.value = ""
    looserInput.value = ""

    // Give focus to the winner field
    winnerInput.focus()
}

// Give winner field focus and do initial table update on load
document.getElementById("winner").focus()
updateTable()
    </script>
</body>
</html>
